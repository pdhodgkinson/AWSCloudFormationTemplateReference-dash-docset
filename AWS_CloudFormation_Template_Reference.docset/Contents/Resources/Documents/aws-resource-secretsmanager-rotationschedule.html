<!DOCTYPE html>
<html>
<head>
    <link href="css/awsdocs.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/awsdocs.min.js"></script>
    <meta charset="utf-8">
</head>
<body>
    <div id="content" style="padding: 10px 30px;">
    <h1 class="topictitle" id="aws-resource-secretsmanager-rotationschedule">AWS::SecretsManager::RotationSchedule</h1><p>The <code class="code">AWS::SecretsManager::RotationSchedule</code> resource configures rotation for
                        a secret. The secret must already be configured with the details of the database or
                        service. If you define both the secret and the database or service in an AWS CloudFormation
                        template, then define the <a href="aws-resource-secretsmanager-secrettargetattachment.html">AWS::SecretsManager::SecretTargetAttachment</a> resource to populate the secret
                        with the connection details of the database or service before you attempt to configure
                        rotation.
                     </p><div class="aws-note">
                        <p class="aws-note">Important</p>
                        <p>When you configure rotation for a secret, AWS CloudFormation automatically rotates
                           the secret one time. Ensure that you configure all your clients to retrieve the secret
                           using Secrets Manager before configuring rotation to prevent breaking them.
                        </p>
                     </div><h2 id="aws-resource-secretsmanager-rotationschedule-syntax">Syntax</h2><p>To declare this entity in your AWS CloudFormation template, use the following syntax:</p><div id="JSON" name="JSON" class="section langfilter">
                        <h3 id="aws-resource-secretsmanager-rotationschedule-syntax.json">JSON</h3><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="json ">{
  &quot;Type&quot; : &quot;AWS::SecretsManager::RotationSchedule&quot;,
  &quot;Properties&quot; : {
      &quot;<a href="#cfn-secretsmanager-rotationschedule-rotationlambdaarn">RotationLambdaARN</a>&quot; : <em class="replaceable"><code>String</code></em>,
      &quot;<a href="#cfn-secretsmanager-rotationschedule-rotationrules">RotationRules</a>&quot; : <em class="replaceable"><code><a href="aws-properties-secretsmanager-rotationschedule-rotationrules.html">RotationRules</a></code></em>,
      &quot;<a href="#cfn-secretsmanager-rotationschedule-secretid">SecretId</a>&quot; : <em class="replaceable"><code>String</code></em>
    }
}
</code></pre></div><div id="YAML" name="YAML" class="section langfilter">
                        <h3 id="aws-resource-secretsmanager-rotationschedule-syntax.yaml">YAML</h3><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="yaml ">Type: AWS::SecretsManager::RotationSchedule
Properties: 
  <a href="#cfn-secretsmanager-rotationschedule-rotationlambdaarn">RotationLambdaARN</a>: <em class="replaceable"><code>String</code></em>
  <a href="#cfn-secretsmanager-rotationschedule-rotationrules">RotationRules</a>: <em class="replaceable"><code>
    <a href="aws-properties-secretsmanager-rotationschedule-rotationrules.html">RotationRules</a></code></em>
  <a href="#cfn-secretsmanager-rotationschedule-secretid">SecretId</a>: <em class="replaceable"><code>String</code></em>
</code></pre></div><h2 id="aws-resource-secretsmanager-rotationschedule-properties">Properties</h2><div class="variablelist">
                        <dl>
                           <dt><a id="cfn-secretsmanager-rotationschedule-rotationlambdaarn"></a><span class="term"><code class="code">RotationLambdaARN</code></span></dt>
                           <dd>
                              
                              <p>Specifies the ARN of the Lambda function that can rotate the secret. If you don&apos;t
                                 specify this parameter, then the secret must already have the ARN of a Lambda function
                                 configured. To reference a Lambda function that&apos;s also created in this template, use
                                 the
                                 <a href="intrinsic-function-reference-ref.html">Ref</a> function with the function&apos;s logical ID.
                              </p>
                              
                              <p><em>Required</em>: No
                              </p>
                              <p><em>Type</em>: String
                              </p>
                              <p><em>Update requires</em>: <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-update-behaviors.html#update-no-interrupt">No interruption</a></p>
                           </dd>
                           <dt><a id="cfn-secretsmanager-rotationschedule-rotationrules"></a><span class="term"><code class="code">RotationRules</code></span></dt>
                           <dd>
                              
                              <p>Specifies a structure that defines the rotation schedule for this secret.</p>
                              
                              <p><em>Required</em>: No
                              </p>
                              <p><em>Type</em>: <a href="aws-properties-secretsmanager-rotationschedule-rotationrules.html">RotationRules</a></p>
                              <p><em>Update requires</em>: <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-update-behaviors.html#update-no-interrupt">No interruption</a></p>
                           </dd>
                           <dt><a id="cfn-secretsmanager-rotationschedule-secretid"></a><span class="term"><code class="code">SecretId</code></span></dt>
                           <dd>
                              
                              <p>Specifies the Amazon Resource Name (ARN) or the friendly name of the secret that you
                                 want to rotate. To reference a secret also that&apos;s created in this template, use the
                                 <a href="intrinsic-function-reference-ref.html">Ref</a> function with the secret&apos;s logical ID.
                              </p>
                              
                              <p><em>Required</em>: Yes
                              </p>
                              <p><em>Type</em>: String
                              </p>
                              <p><em>Update requires</em>: <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-update-behaviors.html#update-replacement">Replacement</a></p>
                           </dd>
                        </dl>
                     </div><h2 id="aws-resource-secretsmanager-rotationschedule-return-values">Return Values</h2><h3 id="aws-resource-secretsmanager-rotationschedule-return-values-ref">Ref</h3><p>When you pass the logical ID of an <code class="code">AWS::SecretsManager::RotationSchedule</code>
                        resource to the intrinsic <code class="code">Ref</code> function, the function returns the ARN of the
                        secret that&apos;s being configured, such as:
                     </p><p><em>arn:aws:secretsmanager:
                           us-west-2</em>:<em>123456789012</em>:secret:<em>my-path/my-secret-name</em>-<em>1a2b3c</em>
                        
                     </p><p>This enables you to reference a secret that you create in one part of the stack template
                        from within the definition of another resource later, in the same template. You typically
                        do this when you define the <a href="aws-resource-secretsmanager-secrettargetattachment.html">AWS::SecretsManager::SecretTargetAttachment</a> resource type.
                     </p><p>For more information about using the <code class="code">Ref</code> function, see <a href="intrinsic-function-reference-ref.html">Ref</a>. 
                     </p><h2 id="aws-resource-secretsmanager-rotationschedule--examples">Examples</h2><h3 id="aws-resource-secretsmanager-rotationschedule--examples--Configuring_a_Secret_to_Rotate">Configuring a Secret to Rotate</h3><p>The following example shows a complete example of creating a secret, creating an
                        RDS database instance that&apos;s associated with the secret and configuring it to rotate.
                        The example shows how to define a Lambda rotation function, attach the required trust
                        and permissions policies, and associate the function with the secret on a defined
                        schedule.
                     </p><h4 id="aws-resource-secretsmanager-rotationschedule--examples--Configuring_a_Secret_to_Rotate--json">JSON</h4><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="json ">{
  &quot;MyRDSInstanceRotationSecret&quot;: {
    &quot;Type&quot;: &quot;AWS::SecretsManager::Secret&quot;,
    &quot;Properties&quot;: {
      &quot;Description&quot;: &quot;This is my rds instance secret&quot;,
      &quot;GenerateSecretString&quot;: {
        &quot;SecretStringTemplate&quot;: &quot;{\&quot;username\&quot;: \&quot;admin\&quot;}&quot;,
        &quot;GenerateStringKey&quot;: &quot;password&quot;,
        &quot;PasswordLength&quot;: 16,
        &quot;ExcludeCharacters&quot;: &quot;\&quot;@/\\&quot;
      }
    }
  },
  &quot;SecretRDSInstanceAttachment&quot;: {
    &quot;Type&quot;: &quot;AWS::SecretsManager::SecretTargetAttachment&quot;,
    &quot;Properties&quot;: {
      &quot;SecretId&quot;: {&quot;Ref&quot;: &quot;MyRDSInstanceRotationSecret&quot;},
      &quot;TargetId&quot;: {&quot;Ref&quot;: &quot;MyDBInstance&quot;},
      &quot;TargetType&quot;: &quot;AWS::RDS::DBInstance&quot;
    }
  },
  &quot;MyDBInstance&quot;: {
    &quot;Type&quot;: &quot;AWS::RDS::DBInstance&quot;,
    &quot;Properties&quot;: {
      &quot;AllocatedStorage&quot;: &quot;&#x2019;20&#x2019;&quot;,
      &quot;DBInstanceClass&quot;: &quot;db.t2.micro&quot;,
      &quot;Engine&quot;: &quot;mysql&quot;,
      &quot;MasterUsername&quot;: {&quot;Fn::Join&quot;: [
        &quot;&quot;,
        [&quot;{{resolve:secretsmanager:&quot;,{&quot;Ref&quot;: &quot;MyRDSInstanceRotationSecret&quot;},&quot;::username}}&quot;]
      ]},
      &quot;MasterUserPassword&quot;: {&quot;Fn::Join&quot;: [
        &quot;&quot;,
        [&quot;{{resolve:secretsmanager:&quot;,{&quot;Ref&quot;: &quot;MyRDSInstanceRotationSecret&quot;},&quot;::password}}&quot;]
      ]},
      &quot;BackupRetentionPeriod&quot;: 0,
      &quot;DBInstanceIdentifier&quot;: &quot;rotation-instance&quot;
    }
  },
  &quot;MySecretRotationSchedule&quot;: {
    &quot;Type&quot;: &quot;&#x201C;AWS::SecretsManager::RotationSchedule\&quot;&quot;,
    &quot;DependsOn&quot;: &quot;SecretRDSInstanceAttachment&quot;,
    &quot;Properties&quot;: {
      &quot;SecretId&quot;: {&quot;Ref&quot;: &quot;MyRDSInstanceRotationSecret&quot;},
      &quot;RotationLambdaARN&quot;: {&quot;Fn::GetAtt&quot;: [&quot;MyRotationLambda&quot;, &quot;Arn&quot;]},
      &quot;RotationRules&quot;: {
        &quot;AutomaticallyAfterDays&quot;: 5
      }
    }
  },
  &quot;LambdaInvokePermission&quot;: {
    &quot;Type&quot;: &quot;AWS::Lambda::Permission&quot;,
    &quot;DependsOn&quot;: &quot;MyRotationLambda&quot;,
    &quot;Properties&quot;: {
      &quot;FunctionName&quot;: &quot;cfn-rotation-lambda&quot;,
      &quot;Action&quot;: &quot;lambda:InvokeFunction&quot;,
      &quot;Principal&quot;: &quot;secretsmanager.amazonaws.com&quot;
    }
  },
  &quot;MyLambdaExecutionRole&quot;: {
    &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
    &quot;Properties&quot;: {
      &quot;RoleName&quot;: &quot;cfn-rotation-lambda-role&quot;,
      &quot;AssumeRolePolicyDocument&quot;: {
        &quot;Version&quot;: &quot;2012-10-17&quot;,
        &quot;Statement&quot;: [
          {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
              &quot;Service&quot;: [
                &quot;lambda.amazonaws.com&quot;
              ]
            },
            &quot;Action&quot;: [
              &quot;sts:AssumeRole&quot;
            ]
          }
        ]
      },
      &quot;Policies&quot;: [
        {
          &quot;PolicyName&quot;: &quot;AWSSecretsManagerRotationPolicy&quot;,
          &quot;PolicyDocument&quot;: {
            &quot;Version&quot;: &quot;2012-10-17&quot;,
            &quot;Statement&quot;: [
              {
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Action&quot;: [
                  &quot;secretsmanager:DescribeSecret&quot;,
                  &quot;secretsmanager:GetSecretValue&quot;,
                  &quot;secretsmanager:PutSecretValue&quot;,
                  &quot;secretsmanager:UpdateSecretVersionStage&quot;
                ],
                &quot;Resource&quot;: {&quot;Fn::Sub&quot;: &quot;arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*&quot;},
                &quot;Condition&quot;: {
                  &quot;StringEquals&quot;: {
                    &quot;secretsmanager:resource/AllowRotationLambdaArn&quot;: {
                      &quot;Fn::Sub&quot;: &quot;arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:cfn-rotation-lambda&quot;
                    }
                  }
                }
              },
              {
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Action&quot;: [
                  &quot;secretsmanager:GetRandomPassword&quot;
                ],
                &quot;Resource&quot;: &quot;*&quot;
              },
              {
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Action&quot;: [
                  &quot;logs:CreateLogGroup&quot;,
                  &quot;logs:CreateLogStream&quot;,
                  &quot;logs:PutLogEvents&quot;
                ],
                &quot;Resource&quot;: &quot;arn:aws:logs:*:*:*&quot;
              },
              {
                &quot;Effect&quot;: &quot;Allow&quot;,
                &quot;Action&quot;: [
                  &quot;kms:Decrypt&quot;,
                  &quot;kms:DescribeKey&quot;,
                  &quot;kms:GenerateDataKey&quot;
                ],
                &quot;Resource&quot;: &quot;*&quot;
              }
            ]
          }
        }
      ]
    }
  },
  &quot;MyRotationLambda&quot;: {
    &quot;Type&quot;: &quot;AWS::Lambda::Function&quot;,
    &quot;Properties&quot;: {
      &quot;Runtime&quot;: &quot;python2.7&quot;,
      &quot;Role&quot;: {&quot;Fn::GetAtt&quot;: [&quot;MyLambdaExecutionRole&quot;,&quot;Arn&quot;]},
      &quot;Handler&quot;: &quot;lambda_function.lambda_handler&quot;,
      &quot;Description&quot;: &quot;This is a lambda to rotate MySql user passwd&quot;,
      &quot;FunctionName&quot;: &quot;cfn-rotation-lambda&quot;,
      &quot;Environment&quot;: {
        &quot;Variables&quot;: {
          &quot;SECRETS_MANAGER_ENDPOINT&quot;: {&quot;Fn::Sub&quot;: &quot;https://secretsmanager.${AWS::Region}.amazonaws.com&quot;}
        }
      },
      &quot;Code&quot;: {
        &quot;S3Bucket&quot;: &quot;&lt;% replace-this-with-name-of-s3-bucket-that-contains-lambda-function-code %&gt;&quot;,
        &quot;S3Key&quot;: &quot;&lt;% replace-this-with-path-and-filename-of-zip-file-that-contains-lambda-function-code %&gt;&quot;,
        &quot;S3ObjectVersion&quot;: &quot;&lt;% replace-this-with-lambda-zip-file-version-if-s3-bucket-versioning-is-enabled %&gt;&quot;
      }
    }
  }
}
</code></pre><h4 id="aws-resource-secretsmanager-rotationschedule--examples--Configuring_a_Secret_to_Rotate--yaml">YAML</h4><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="yaml ">#This is a Secret resource with a randomly generated password in its SecretString JSON.
  MyRDSInstanceRotationSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: &quot;This is my rds instance secret&quot;
      GenerateSecretString:
        SecretStringTemplate: &apos;{&quot;username&quot;: &quot;admin&quot;}&apos;
        GenerateStringKey: &quot;password&quot;
        PasswordLength: 16
        ExcludeCharacters: &apos;&quot;@/\&apos;

  # This is an RDS instance resource. The master username and password use dynamic references
  # to resolve values from Secrets Manager. The dynamic reference guarantees that CloudFormation
  # will not log or persist the resolved value. We use a Ref to the secret resource&apos;s logical id
  # to construct the dynamic reference, since the secret name is generated by CloudFormation.
  MyDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: 20
      DBInstanceClass: db.t2.micro
      Engine: mysql
      MasterUsername: !Join [&apos;&apos;, [&apos;{{resolve:secretsmanager:&apos;, !Ref MyRDSInstanceRotationSecret, &apos;::username}}&apos; ]]
      MasterUserPassword: !Join [&apos;&apos;, [&apos;{{resolve:secretsmanager:&apos;, !Ref MyRDSInstanceRotationSecret, &apos;::password}}&apos; ]]
      BackupRetentionPeriod: 0
      DBInstanceIdentifier: &apos;rotation-instance&apos;

  #This is a SecretTargetAttachment resource which updates the referenced Secret resource with properties about
  #the referenced RDS instance
  SecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref MyRDSInstanceRotationSecret
      TargetId: !Ref MyDBInstance
      TargetType: AWS::RDS::DBInstance

  # This is a RotationSchedule resource. It configures rotation of the password for the referenced
  # secret using a Lambda rotation function. The first rotation happens immediately when
  # CloudFormation processes this resource type. All subsequent rotations are scheduled according to
  # the configured rotation rules. We explicitly depend on the SecretTargetAttachment resource to
  # ensure that the secret contains all the information necessary for rotation to succeed.
  MySecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    DependsOn: SecretRDSInstanceAttachment
    Properties:
      SecretId: !Ref MyRDSInstanceRotationSecret
      RotationLambdaARN: !GetAtt MyRotationLambda.Arn
      RotationRules:
        AutomaticallyAfterDays: 5

  #This is a Lambda Permission resource that grants Secrets Manager permission to invoke the function
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    DependsOn: MyRotationLambda
    Properties:
      FunctionName: &apos;cfn-rotation-lambda&apos;
      Action: &apos;lambda:InvokeFunction&apos;
      Principal: secretsmanager.amazonaws.com

  # This is an IAM Role resource. It gets attached to the Lambda rotation function and grants
  # permissions to the function to retrieve and update the secret as part of the rotation process.
  # It also includes the required KMS permissions and CloudWatch logging permissions.
  MyLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: &apos;cfn-rotation-lambda-role&apos;
      AssumeRolePolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          -
            Effect: &quot;Allow&quot;
            Principal:
              Service:
                - &quot;lambda.amazonaws.com&quot;
            Action:
              - &quot;sts:AssumeRole&quot;
      Policies:
        -
          PolicyName: &quot;AWSSecretsManagerRotationPolicy&quot;
          PolicyDocument:
            Version: &quot;2012-10-17&quot;
            Statement:
              -
                Effect: &quot;Allow&quot;
                Action:
                  - &quot;secretsmanager:DescribeSecret&quot;
                  - &quot;secretsmanager:GetSecretValue&quot;
                  - &quot;secretsmanager:PutSecretValue&quot;
                  - &quot;secretsmanager:UpdateSecretVersionStage&quot;
                Resource: !Sub &apos;arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*&apos;
                Condition:
                  StringEquals:
                    secretsmanager:resource/AllowRotationLambdaArn: !Sub &apos;arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:cfn-rotation-lambda&apos;
              -
                Effect: &quot;Allow&quot;
                Action:
                  - &quot;secretsmanager:GetRandomPassword&quot;
                Resource: &quot;*&quot;
              -
                Effect: &quot;Allow&quot;
                Action:
                  - &quot;logs:CreateLogGroup&quot;
                  - &quot;logs:CreateLogStream&quot;
                  - &quot;logs:PutLogEvents&quot;
                Resource: &quot;arn:aws:logs:*:*:*&quot;
              -
                Effect: &quot;Allow&quot;
                Action:
                  - &quot;kms:Decrypt&quot;
                  - &quot;kms:DescribeKey&quot;
                  - &quot;kms:GenerateDataKey&quot;
                Resource: &quot;*&quot;

  # This is a Lambda Function resource. We use this to create the rotation function that rotate
  # our secret. For details about rotation Lambdas, see:
  # https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html
  # This example assumes that the Lambda code is already present in an S3 bucket, and that it
  # is coded to rotate a MySQL database password
  MyRotationLambda:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python2.7
      Role: !GetAtt MyLambdaExecutionRole.Arn
      Handler: lambda_function.lambda_handler
      Description: &apos;This is a lambda to rotate MySql user passwd&apos;
      FunctionName: &apos;cfn-rotation-lambda&apos;
      Environment:
        Variables:
          SECRETS_MANAGER_ENDPOINT: !Sub &apos;https://secretsmanager.${AWS::Region}.amazonaws.com&apos;
      Code:
        S3Bucket: &lt;% replace-this-with-name-of-s3-bucket-that-contains-lambda-function-code %&gt;
        S3Key: &lt;% replace-this-with-path-and-filename-of-zip-file-that-contains-lambda-function-code %&gt;
        S3ObjectVersion: &lt;% replace-this-with-lambda-zip-file-version-if-s3-bucket-versioning-is-enabled %&gt;</code></pre><h2 id="aws-resource-secretsmanager-rotationschedule--seealso">See Also</h2><div class="itemizedlist">
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>
                                 <a href="https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_RotateSecret.html">RotateSecret</a> in the AWS Secrets Manager API Reference
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>
                                 <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html">Rotating Your AWS
                                    Secrets Manager Secrets</a> in the AWS Secrets Manager User Guide
                              </p>
                              
                           </li>
                        </ul>
                     </div><div id="marketing-target"><span class="close-button"></span><div class="marketing-title" id="marketing-title"></div>
                        <div class="marketing-description"><span id="marketing-description"></span><span id="marketing-cta"></span></div>
                     </div></div>
</body>
</html>